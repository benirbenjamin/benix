<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Activation Payments - BenixSpace Admin</title>
  <link rel="icon" href="/static/img/favicon.png" type="image/png" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-light">
  <%- include('../partials/navbar') %>

  <div class="container-fluid mt-4">
    <div class="row">
      <div class="col-12">
        <% if (locals.successMessage) { %>
          <div class="alert alert-success alert-dismissible fade show">
            <%= successMessage %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        <% } %>
        <% if (locals.errorMessage) { %>
          <div class="alert alert-danger alert-dismissible fade show">
            <%= errorMessage %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        <% } %>

        <div class="card shadow">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="fas fa-credit-card"></i> Activation Payments</h4>
            <a href="/admin/dashboard" class="btn btn-light btn-sm">
              <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
          </div>
          <div class="card-body">
            <% if (payments && payments.length > 0) { %>
              <div class="table-responsive">
                <table class="table table-striped table-hover">
                  <thead class="table-dark">
                    <tr>
                      <th>ID</th>
                      <th>User</th>
                      <th>Email</th>
                      <th>Amount (USD)</th>
                      <th>Original Amount</th>
                      <th>Currency</th>
                      <th>Payment Type</th>
                      <th>Payment Method</th>
                      <th>Status</th>
                      <th>User Status</th>
                      <th>Date</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% payments.forEach(payment => { %>
                      <tr>
                        <td><strong>#<%= payment.id %></strong></td>
                        <td>
                          <a href="/admin/users/<%= payment.user_id %>" class="text-decoration-none">
                            <%= payment.username %>
                          </a>
                        </td>
                        <td><%= payment.email %></td>
                        <td>
                          <span class="badge bg-success">$<%= payment.amount_usd %></span>
                        </td>
                        <td><%= payment.amount_original %></td>
                        <td>
                          <span class="badge bg-secondary"><%= payment.currency %></span>
                        </td>
                        <td>
                          <% if (payment.payment_type === 'manual') { %>
                            <span class="badge bg-info">
                              <i class="fas fa-university"></i> Manual
                            </span>
                          <% } else { %>
                            <span class="badge bg-primary">
                              <i class="fas fa-bolt"></i> Automatic
                            </span>
                          <% } %>
                        </td>
                        <td>
                          <% if (payment.payment_method === 'manual_approval') { %>
                            <span class="badge bg-success">
                              <i class="fas fa-user-shield"></i> Manual Approval
                            </span>
                          <% } else if (payment.payment_method) { %>
                            <span class="badge bg-info"><%= payment.payment_method %></span>
                          <% } else { %>
                            <span class="text-muted">Flutterwave</span>
                          <% } %>
                        </td>
                        <td>
                          <% if (payment.payment_status === 'successful') { %>
                            <span class="badge bg-success">
                              <i class="fas fa-check"></i> Successful
                            </span>
                          <% } else if (payment.payment_status === 'pending') { %>
                            <span class="badge bg-warning">
                              <i class="fas fa-clock"></i> Pending
                            </span>
                          <% } else if (payment.payment_status === 'failed') { %>
                            <span class="badge bg-danger">
                              <i class="fas fa-times"></i> Failed
                            </span>
                          <% } else if (payment.payment_status === 'cancelled') { %>
                            <span class="badge bg-secondary">
                              <i class="fas fa-ban"></i> Cancelled
                            </span>
                          <% } %>
                        </td>
                        <td>
                          <% if (payment.user_status === 'active') { %>
                            <span class="badge bg-success">Active</span>
                          <% } else if (payment.user_status === 'pending') { %>
                            <span class="badge bg-warning">Pending</span>
                          <% } else { %>
                            <span class="badge bg-secondary"><%= payment.user_status %></span>
                          <% } %>
                        </td>
                        <td>
                          <%= new Date(payment.created_at).toLocaleDateString() %>
                          <br>
                          <small class="text-muted">
                            <%= new Date(payment.created_at).toLocaleTimeString() %>
                          </small>
                        </td>
                        <td>
                          <div class="btn-group btn-group-sm">
                            <a href="/admin/users/<%= payment.user_id %>" class="btn btn-outline-primary btn-sm" title="View User">
                              <i class="fas fa-eye"></i>
                            </a>
                            <% if (payment.payment_type === 'manual') { %>
                              <button class="btn btn-outline-info btn-sm" title="View Manual Payment Details" 
                                      onclick="viewManualPayment(<%= payment.id %>)">
                                <i class="fas fa-receipt"></i>
                              </button>
                              <button class="btn btn-outline-success btn-sm" title="Send WhatsApp to Admin" 
                                      onclick="sendWhatsApp(<%= payment.manual_payment_id || payment.id %>)">
                                <i class="fab fa-whatsapp"></i>
                              </button>
                            <% } %>
                            <% if (payment.flutterwave_tx_ref) { %>
                              <button class="btn btn-outline-info btn-sm" title="Transaction Reference" 
                                      onclick="copyToClipboard('<%= payment.flutterwave_tx_ref %>')">
                                <i class="fas fa-copy"></i>
                              </button>
                            <% } %>
                            <% if (payment.payment_status === 'pending') { %>
                              <button class="btn btn-success btn-sm" title="Approve Payment" 
                                      onclick="approvePayment(<%= payment.id %>, '<%= payment.username %>', '<%= payment.payment_type %>')">
                                <i class="fas fa-check"></i>
                              </button>
                              <button class="btn btn-danger btn-sm" title="Reject Payment" 
                                      onclick="rejectPayment(<%= payment.id %>, '<%= payment.username %>')">
                                <i class="fas fa-times"></i>
                              </button>
                            <% } %>
                          </div>
                        </td>
                      </tr>
                      <% if (payment.payment_type === 'manual' && payment.manual_account_name) { %>
                        <tr class="table-light">
                          <td colspan="12">
                            <div class="small">
                              <strong>Manual Payment Details:</strong>
                              <span class="badge bg-light text-dark">Account: <%= payment.manual_account_name %></span>
                              <% if (payment.manual_phone_number) { %>
                                <span class="badge bg-light text-dark">Phone: <%= payment.manual_phone_number %></span>
                              <% } %>
                              <% if (payment.manual_account_number) { %>
                                <span class="badge bg-light text-dark">Ref: <%= payment.manual_account_number %></span>
                              <% } %>
                              <% if (payment.payment_screenshot_url) { %>
                                <a href="<%= payment.payment_screenshot_url %>" target="_blank" class="badge bg-primary text-white text-decoration-none">
                                  <i class="fas fa-image"></i> View Screenshot
                                </a>
                              <% } %>
                              <% if (payment.manual_status) { %>
                                <span class="badge bg-<%= payment.manual_status === 'approved' ? 'success' : payment.manual_status === 'rejected' ? 'danger' : 'warning' %>">
                                  Manual Status: <%= payment.manual_status %>
                                </span>
                              <% } %>
                              <% if (payment.whatsapp_sent) { %>
                                <span class="badge bg-success"><i class="fab fa-whatsapp"></i> WhatsApp Sent</span>
                              <% } %>
                            </div>
                          </td>
                        </tr>
                      <% } %>
                    <% }); %>
                  </tbody>
                </table>
              </div>
            <% } else { %>
              <div class="text-center py-5">
                <i class="fas fa-credit-card fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No activation payments found</h5>
                <p class="text-muted">Activation payments will appear here once users start paying for activation.</p>
              </div>
            <% } %>
          </div>
        </div>

        <!-- Payment Statistics -->
        <div class="row mt-4">
          <div class="col-md-3">
            <div class="card bg-primary text-white">
              <div class="card-body text-center">
                <h5>Total Payments</h5>
                <h3><%= payments ? payments.length : 0 %></h3>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-success text-white">
              <div class="card-body text-center">
                <h5>Successful</h5>
                <h3><%= payments ? payments.filter(p => p.payment_status === 'successful').length : 0 %></h3>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-warning text-white">
              <div class="card-body text-center">
                <h5>Pending</h5>
                <h3><%= payments ? payments.filter(p => p.payment_status === 'pending').length : 0 %></h3>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-danger text-white">
              <div class="card-body text-center">
                <h5>Failed</h5>
                <h3><%= payments ? payments.filter(p => p.payment_status === 'failed').length : 0 %></h3>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%- include('../partials/footer') %>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(function() {
        // Show success feedback
        const button = event.target.closest('button');
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i>';
        button.classList.remove('btn-outline-info');
        button.classList.add('btn-success');
        
        setTimeout(() => {
          button.innerHTML = originalHTML;
          button.classList.remove('btn-success');
          button.classList.add('btn-outline-info');
        }, 2000);
      });
    }

    function approvePayment(paymentId, username, paymentType) {
      let confirmMessage = `Are you sure you want to approve the activation payment for ${username}? This will activate their account and process referral commissions.`;
      
      if (paymentType === 'manual') {
        const adminNotes = prompt(`Enter admin notes for ${username}'s manual payment approval (optional):`, 'Manual payment verified and approved');
        if (adminNotes === null) return; // User cancelled
        
        // Create form and submit with admin notes
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/activation-payments/${paymentId}/approve`;
        
        // Add admin notes input
        const notesInput = document.createElement('input');
        notesInput.type = 'hidden';
        notesInput.name = 'admin_notes';
        notesInput.value = adminNotes;
        form.appendChild(notesInput);
        
        // Add CSRF token if available
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        if (csrfToken) {
          const csrfInput = document.createElement('input');
          csrfInput.type = 'hidden';
          csrfInput.name = '_token';
          csrfInput.value = csrfToken.getAttribute('content');
          form.appendChild(csrfInput);
        }
        
        document.body.appendChild(form);
        form.submit();
      } else {
        if (confirm(confirmMessage)) {
          // Create form and submit
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = `/admin/activation-payments/${paymentId}/approve`;
          
          // Add CSRF token if available
          const csrfToken = document.querySelector('meta[name="csrf-token"]');
          if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = '_token';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
          }
          
          document.body.appendChild(form);
          form.submit();
        }
      }
    }

    function viewManualPayment(paymentId) {
      // Find the payment row
      const payments = <%- JSON.stringify(payments) %>;
      const payment = payments.find(p => p.id === paymentId);
      
      if (!payment) {
        alert('Payment details not found');
        return;
      }
      
      let details = `Manual Payment Details for ${payment.username}:\n\n`;
      details += `Amount: ${payment.amount_original} ${payment.currency}\n`;
      details += `Account Name: ${payment.manual_account_name || 'N/A'}\n`;
      details += `Phone Number: ${payment.manual_phone_number || 'N/A'}\n`;
      details += `Account/Ref Number: ${payment.manual_account_number || 'N/A'}\n`;
      details += `Manual Status: ${payment.manual_status || 'pending'}\n`;
      details += `WhatsApp Sent: ${payment.whatsapp_sent ? 'Yes' : 'No'}\n`;
      details += `Admin Notes: ${payment.admin_notes || 'None'}\n`;
      
      if (payment.payment_screenshot_url) {
        details += `\nScreenshot available: ${payment.payment_screenshot_url}`;
        if (confirm(details + '\n\nWould you like to view the payment screenshot?')) {
          window.open(payment.payment_screenshot_url, '_blank');
        }
      } else {
        alert(details);
      }
    }

    function rejectPayment(paymentId, username) {
      const reason = prompt(`Enter rejection reason for ${username}'s payment:`, 'Payment verification failed');
      if (reason !== null) {
        // Create form and submit
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/activation-payments/${paymentId}/reject`;
        
        // Add reason input
        const reasonInput = document.createElement('input');
        reasonInput.type = 'hidden';
        reasonInput.name = 'reason';
        reasonInput.value = reason;
        form.appendChild(reasonInput);
        
        // Add CSRF token if available
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        if (csrfToken) {
          const csrfInput = document.createElement('input');
          csrfInput.type = 'hidden';
          csrfInput.name = '_token';
          csrfInput.value = csrfToken.getAttribute('content');
          form.appendChild(csrfInput);
        }
        
        document.body.appendChild(form);
        form.submit();
      }
    }

    async function sendWhatsApp(manualPaymentId) {
      try {
        const response = await fetch(`/admin/manual-payment/${manualPaymentId}/whatsapp`);
        const result = await response.json();
        
        if (result.success) {
          // Show preview with screenshot info
          const confirmMessage = `WhatsApp message will be sent to ${result.adminPhone}\n\nMessage includes:\n- Payment details\n- Direct link to payment screenshot\n- Admin panel link\n\nOpen WhatsApp now?`;
          
          if (confirm(confirmMessage)) {
            // Open WhatsApp with the pre-filled message including screenshot link
            window.open(result.whatsappUrl, '_blank');
            
            // Visual feedback
            const button = event.target.closest('button');
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="fab fa-whatsapp"></i> Sent';
            button.classList.remove('btn-outline-success');
            button.classList.add('btn-success');
            
            setTimeout(() => {
              button.innerHTML = originalHTML;
              button.classList.remove('btn-success');
              button.classList.add('btn-outline-success');
            }, 3000);
          }
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        console.error('WhatsApp error:', error);
        alert('Failed to generate WhatsApp message');
      }
    }

    function viewManualPayment(paymentId) {
      // Find the payment in the data and show details
      const payments = <%- JSON.stringify(payments) %>;
      const payment = payments.find(p => p.id === paymentId);
      
      if (payment && payment.payment_type === 'manual') {
        let details = `Manual Payment Details:\n\n`;
        details += `User: ${payment.username}\n`;
        details += `Amount: ${payment.amount_original} ${payment.currency}\n`;
        if (payment.manual_account_name) details += `Account Name: ${payment.manual_account_name}\n`;
        if (payment.manual_phone_number) details += `Phone: ${payment.manual_phone_number}\n`;
        if (payment.manual_account_number) details += `Account/Ref: ${payment.manual_account_number}\n`;
        if (payment.payment_screenshot_url) details += `Screenshot: Available\n`;
        if (payment.manual_status) details += `Manual Status: ${payment.manual_status}\n`;
        
        alert(details);
        
        // If screenshot exists, offer to view it
        if (payment.payment_screenshot_url) {
          if (confirm('Would you like to view the payment screenshot?')) {
            window.open(payment.payment_screenshot_url, '_blank');
          }
        }
      }
    }
  </script>
</body>
</html>
