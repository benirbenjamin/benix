<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notifications - BenixSpace Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .notification-card {
      transition: all 0.3s ease;
      border-left: 4px solid #dee2e6;
    }
    .notification-card.type-success { border-left-color: #28a745; }
    .notification-card.type-warning { border-left-color: #ffc107; }
    .notification-card.type-error { border-left-color: #dc3545; }
    .notification-card.type-critical { border-left-color: #6f42c1; }
    .notification-card.type-info { border-left-color: #17a2b8; }
    
    .notification-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .unread {
      background-color: #f8f9fa;
      font-weight: 600;
    }
    
    .email-log {
      font-size: 0.875rem;
    }
    
    .status-badge {
      font-size: 0.75rem;
      padding: 0.25em 0.5em;
    }
    
    .system-status {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Include sidebar navigation -->
      <%- include('../partials/navbar') %>
      
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2"><i class="fas fa-bell me-2"></i>Notifications & Email Management</h1>
          <div class="btn-toolbar mb-2 mb-md-0">
            <button class="btn btn-sm btn-outline-primary me-2" onclick="refreshStatus()">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#broadcastModal">
              <i class="fas fa-broadcast-tower"></i> Broadcast
            </button>
          </div>
        </div>

        <!-- System Status Cards -->
        <div class="row mb-4">
          <div class="col-lg-3 col-md-6 mb-3">
            <div class="card text-white bg-primary">
              <div class="card-body">
                <div class="d-flex justify-content-between">
                  <div>
                    <h5 class="card-title">Total Notifications</h5>
                    <h3><%= stats.total || 0 %></h3>
                  </div>
                  <div class="align-self-center">
                    <i class="fas fa-bell fa-2x"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-lg-3 col-md-6 mb-3">
            <div class="card text-white bg-warning">
              <div class="card-body">
                <div class="d-flex justify-content-between">
                  <div>
                    <h5 class="card-title">Unread</h5>
                    <h3><%= stats.unread || 0 %></h3>
                  </div>
                  <div class="align-self-center">
                    <i class="fas fa-exclamation-circle fa-2x"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-lg-3 col-md-6 mb-3">
            <div class="card text-white bg-success">
              <div class="card-body">
                <div class="d-flex justify-content-between">
                  <div>
                    <h5 class="card-title">Emails Sent</h5>
                    <h3><%= stats.email_sent || 0 %></h3>
                  </div>
                  <div class="align-self-center">
                    <i class="fas fa-envelope fa-2x"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-lg-3 col-md-6 mb-3">
            <div class="card text-white bg-danger">
              <div class="card-body">
                <div class="d-flex justify-content-between">
                  <div>
                    <h5 class="card-title">Critical Alerts</h5>
                    <h3><%= stats.critical || 0 %></h3>
                  </div>
                  <div class="align-self-center">
                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- System Status Panel -->
        <div class="system-status">
          <div class="row">
            <div class="col-md-8">
              <h4><i class="fas fa-server me-2"></i>System Status</h4>
              <div id="systemStatus">
                <div class="d-flex align-items-center">
                  <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                  <span>Loading system status...</span>
                </div>
              </div>
            </div>
            <div class="col-md-4 text-end">
              <button class="btn btn-light" onclick="triggerReport('health')">
                <i class="fas fa-heartbeat"></i> Health Check
              </button>
              <button class="btn btn-light" onclick="testEmail()">
                <i class="fas fa-envelope-open"></i> Test Email
              </button>
            </div>
          </div>
        </div>

        <!-- Report Triggers -->
        <div class="card mb-4">
          <div class="card-header">
            <h5><i class="fas fa-chart-line me-2"></i>Manual Report Triggers</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3">
                <button class="btn btn-outline-primary w-100" onclick="triggerReport('daily')">
                  <i class="fas fa-calendar-day"></i><br>Daily Report
                </button>
              </div>
              <div class="col-md-3">
                <button class="btn btn-outline-info w-100" onclick="triggerReport('weekly')">
                  <i class="fas fa-calendar-week"></i><br>Weekly Report
                </button>
              </div>
              <div class="col-md-3">
                <button class="btn btn-outline-success w-100" onclick="triggerReport('monthly')">
                  <i class="fas fa-calendar-alt"></i><br>Monthly Report
                </button>
              </div>
              <div class="col-md-3">
                <button class="btn btn-outline-warning w-100" onclick="triggerReport('health')">
                  <i class="fas fa-stethoscope"></i><br>Health Check
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="notificationTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications" type="button" role="tab">
              <i class="fas fa-bell"></i> Recent Notifications
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="email-logs-tab" data-bs-toggle="tab" data-bs-target="#email-logs" type="button" role="tab">
              <i class="fas fa-envelope"></i> Email Logs
            </button>
          </li>
        </ul>

        <div class="tab-content" id="notificationTabsContent">
          <!-- Notifications Tab -->
          <div class="tab-pane fade show active" id="notifications" role="tabpanel">
            <div class="mt-3">
              <% if (notifications && notifications.length > 0) { %>
                <% notifications.forEach(function(notification) { %>
                  <div class="card notification-card type-<%= notification.type %> mb-3 <%= !notification.is_read ? 'unread' : '' %>">
                    <div class="card-body">
                      <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                          <h6 class="card-title">
                            <% if (notification.type === 'critical') { %>
                              <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                            <% } else if (notification.type === 'success') { %>
                              <i class="fas fa-check-circle text-success me-2"></i>
                            <% } else if (notification.type === 'warning') { %>
                              <i class="fas fa-exclamation-circle text-warning me-2"></i>
                            <% } else if (notification.type === 'error') { %>
                              <i class="fas fa-times-circle text-danger me-2"></i>
                            <% } else { %>
                              <i class="fas fa-info-circle text-info me-2"></i>
                            <% } %>
                            <%= notification.title %>
                          </h6>
                          <p class="card-text"><%= notification.message %></p>
                          <div class="d-flex align-items-center text-muted small">
                            <% if (notification.username) { %>
                              <span class="me-3">
                                <i class="fas fa-user me-1"></i>
                                <%= notification.username %> (<%= notification.email %>)
                              </span>
                            <% } %>
                            <span class="me-3">
                              <i class="fas fa-clock me-1"></i>
                              <%= new Date(notification.created_at).toLocaleString() %>
                            </span>
                            <span class="me-3">
                              <i class="fas fa-tag me-1"></i>
                              <%= notification.category %>
                            </span>
                            <% if (notification.email_sent) { %>
                              <span class="badge bg-success">Email Sent</span>
                            <% } %>
                          </div>
                        </div>
                        <div class="ms-3">
                          <span class="badge bg-<%= notification.type === 'critical' ? 'danger' : notification.type === 'success' ? 'success' : notification.type === 'warning' ? 'warning' : notification.type === 'error' ? 'danger' : 'info' %>">
                            <%= notification.type.toUpperCase() %>
                          </span>
                          <div class="mt-2">
                            <small class="text-muted">Priority: <%= notification.priority %></small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                <% }); %>
              <% } else { %>
                <div class="text-center py-5">
                  <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                  <h5 class="text-muted">No notifications found</h5>
                  <p class="text-muted">Recent notifications will appear here</p>
                </div>
              <% } %>
            </div>
          </div>

          <!-- Email Logs Tab -->
          <div class="tab-pane fade" id="email-logs" role="tabpanel">
            <div class="mt-3">
              <% if (emailLogs && emailLogs.length > 0) { %>
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>Status</th>
                        <th>Event Type</th>
                        <th>Details</th>
                        <th>Timestamp</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% emailLogs.forEach(function(log) { %>
                        <tr class="email-log">
                          <td>
                            <span class="badge status-badge bg-<%= log.status === 'sent' ? 'success' : log.status === 'failed' ? 'danger' : log.status === 'system' ? 'info' : 'secondary' %>">
                              <%= log.status.toUpperCase() %>
                            </span>
                          </td>
                          <td><%= log.event_type %></td>
                          <td>
                            <% if (log.details) { %>
                              <% try { %>
                                <% const details = JSON.parse(log.details); %>
                                <% if (details.to) { %>
                                  To: <%= details.to %><br>
                                <% } %>
                                <% if (details.subject) { %>
                                  Subject: <%= details.subject %><br>
                                <% } %>
                                <% if (details.error) { %>
                                  <span class="text-danger">Error: <%= details.error %></span>
                                <% } %>
                              <% } catch (e) { %>
                                <%= log.details %>
                              <% } %>
                            <% } else { %>
                              -
                            <% } %>
                          </td>
                          <td>
                            <small><%= new Date(log.created_at).toLocaleString() %></small>
                          </td>
                        </tr>
                      <% }); %>
                    </tbody>
                  </table>
                </div>
              <% } else { %>
                <div class="text-center py-5">
                  <i class="fas fa-envelope-open fa-3x text-muted mb-3"></i>
                  <h5 class="text-muted">No email logs found</h5>
                  <p class="text-muted">Email activity logs will appear here</p>
                </div>
              <% } %>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Broadcast Modal -->
  <div class="modal fade" id="broadcastModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Broadcast Notification</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="broadcastForm">
          <div class="modal-body">
            <div class="mb-3">
              <label for="broadcastTitle" class="form-label">Title</label>
              <input type="text" class="form-control" id="broadcastTitle" required>
            </div>
            <div class="mb-3">
              <label for="broadcastMessage" class="form-label">Message</label>
              <textarea class="form-control" id="broadcastMessage" rows="4" required></textarea>
            </div>
            <div class="mb-3">
              <label for="broadcastType" class="form-label">Type</label>
              <select class="form-select" id="broadcastType">
                <option value="info">Info</option>
                <option value="success">Success</option>
                <option value="warning">Warning</option>
                <option value="error">Error</option>
              </select>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="sendEmail">
              <label class="form-check-label" for="sendEmail">
                Send email notifications
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Send Broadcast</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // System status check
    async function refreshStatus() {
      const statusDiv = document.getElementById('systemStatus');
      statusDiv.innerHTML = '<div class="d-flex align-items-center"><div class="spinner-border spinner-border-sm me-2" role="status"></div><span>Checking system status...</span></div>';
      
      try {
        const response = await fetch('/admin/system-status');
        const data = await response.json();
        
        if (data.success) {
          const emailStatus = data.email.connected ? 
            `<span class="badge bg-success">Connected (${data.email.config})</span>` : 
            `<span class="badge bg-danger">Disconnected</span>`;
            
          statusDiv.innerHTML = `
            <div class="row">
              <div class="col-md-6">
                <strong>Email Service:</strong> ${emailStatus}<br>
                <strong>Total Users:</strong> ${data.stats.total_users}<br>
                <strong>Orders Today:</strong> ${data.stats.orders_today}
              </div>
              <div class="col-md-6">
                <strong>Scheduler:</strong> <span class="badge bg-${Object.values(data.scheduler).some(s => s.running) ? 'success' : 'warning'}">${Object.values(data.scheduler).some(s => s.running) ? 'Running' : 'Stopped'}</span><br>
                <strong>Unread Notifications:</strong> ${data.stats.unread_notifications}<br>
                <strong>Failed Emails (1h):</strong> ${data.stats.failed_emails_hour}
              </div>
            </div>
            <small class="text-light">Last updated: ${new Date(data.timestamp).toLocaleString()}</small>
          `;
        } else {
          statusDiv.innerHTML = '<span class="badge bg-danger">Error checking status</span>';
        }
      } catch (error) {
        statusDiv.innerHTML = '<span class="badge bg-danger">Error: ' + error.message + '</span>';
      }
    }

    // Trigger reports
    async function triggerReport(type) {
      const button = event.target.closest('button');
      const originalText = button.innerHTML;
      button.disabled = true;
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
      
      try {
        const response = await fetch('/admin/reports/trigger', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reportType: type })
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert(`${type.charAt(0).toUpperCase() + type.slice(1)} report triggered successfully!`);
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        button.disabled = false;
        button.innerHTML = originalText;
      }
    }

    // Test email
    async function testEmail() {
      const email = prompt('Enter email address for test:');
      if (!email) return;
      
      try {
        const response = await fetch('/admin/test-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, testType: 'basic' })
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert('Test email sent successfully!');
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Broadcast form
    document.getElementById('broadcastForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const title = document.getElementById('broadcastTitle').value;
      const message = document.getElementById('broadcastMessage').value;
      const type = document.getElementById('broadcastType').value;
      const sendEmail = document.getElementById('sendEmail').checked;
      
      try {
        const response = await fetch('/admin/notifications/broadcast', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, message, type, sendEmail })
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert('Broadcast sent successfully!');
          location.reload();
        } else {
          alert('Error: ' + data.message);
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    });

    // Load status on page load
    refreshStatus();
    
    // Auto-refresh status every 30 seconds
    setInterval(refreshStatus, 30000);
  </script>
</body>
</html>
