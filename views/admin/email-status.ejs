<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email Service Status - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .status-card {
      border-left: 4px solid #007bff;
    }
    .status-working {
      border-left-color: #28a745;
    }
    .status-error {
      border-left-color: #dc3545;
    }
    .status-warning {
      border-left-color: #ffc107;
    }
    .config-detail {
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      background-color: #f8f9fa;
      padding: 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <%- include('../partials/navbar') %>

  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="fas fa-envelope me-2"></i>Email Service Status</h2>
      <a href="/admin/dashboard" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
      </a>
    </div>

          <!-- Success/Error Messages -->
          <% if (typeof successMessage !== 'undefined' && successMessage) { %>
            <div class="alert alert-success alert-dismissible fade show" role="alert">
              <i class="fas fa-check-circle me-2"></i><%= successMessage %>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          <% } %>
          
          <% if (typeof errorMessage !== 'undefined' && errorMessage) { %>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              <i class="fas fa-exclamation-triangle me-2"></i><%= errorMessage %>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          <% } %>

          <!-- Email Service Status Card -->
          <div class="card status-card <%= status.initialized ? (status.fallback_mode ? 'status-warning' : 'status-working') : 'status-error' %> mb-4">
            <div class="card-header">
              <h5 class="mb-0">
                <% if (status.initialized) { %>
                  <% if (status.fallback_mode) { %>
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>Email Service (Fallback Mode)
                  <% } else { %>
                    <i class="fas fa-check-circle text-success me-2"></i>Email Service (Active)
                  <% } %>
                <% } else { %>
                  <i class="fas fa-times-circle text-danger me-2"></i>Email Service (Not Working)
                <% } %>
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <h6>Service Status</h6>
                  <ul class="list-unstyled">
                    <li>
                      <strong>Initialized:</strong> 
                      <span class="badge bg-<%= status.initialized ? 'success' : 'danger' %>">
                        <%= status.initialized ? 'Yes' : 'No' %>
                      </span>
                    </li>
                    <li>
                      <strong>Credentials Configured:</strong> 
                      <span class="badge bg-<%= status.credentials_configured ? 'success' : 'warning' %>">
                        <%= status.credentials_configured ? 'Yes' : 'No' %>
                      </span>
                    </li>
                    <% if (status.fallback_mode) { %>
                      <li>
                        <strong>Mode:</strong> 
                        <span class="badge bg-warning">Fallback (Logging Only)</span>
                      </li>
                    <% } %>
                  </ul>
                </div>
                <div class="col-md-6">
                  <% if (status.config) { %>
                    <h6>Current Configuration</h6>
                    <div class="config-detail">
                      <strong>Provider:</strong> <%= status.config.name %><br>
                      <strong>Host:</strong> <%= status.config.host %><br>
                      <strong>Port:</strong> <%= status.config.port %><br>
                      <strong>Secure:</strong> <%= status.config.secure ? 'Yes (SSL/TLS)' : 'No' %>
                    </div>
                  <% } else { %>
                    <h6>Configuration</h6>
                    <p class="text-muted">No active configuration</p>
                  <% } %>
                </div>
              </div>
            </div>
          </div>

          <!-- Environment Variables Status -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Environment Variables</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <h6>SMTP Configuration</h6>
                  <ul class="list-unstyled">
                    <li>
                      <strong>SMTP_HOST:</strong> 
                      <span class="badge bg-<%= process.env.SMTP_HOST ? 'success' : 'warning' %>">
                        <%= process.env.SMTP_HOST ? 'Set' : 'Not Set' %>
                      </span>
                      <% if (process.env.SMTP_HOST) { %>
                        <small class="text-muted">(<%= process.env.SMTP_HOST %>)</small>
                      <% } %>
                    </li>
                    <li>
                      <strong>SMTP_PORT:</strong> 
                      <span class="badge bg-<%= process.env.SMTP_PORT ? 'success' : 'warning' %>">
                        <%= process.env.SMTP_PORT ? 'Set' : 'Not Set' %>
                      </span>
                      <% if (process.env.SMTP_PORT) { %>
                        <small class="text-muted">(<%= process.env.SMTP_PORT %>)</small>
                      <% } %>
                    </li>
                    <li>
                      <strong>SMTP_SECURE:</strong> 
                      <span class="badge bg-<%= process.env.SMTP_SECURE ? 'success' : 'warning' %>">
                        <%= process.env.SMTP_SECURE || 'Default' %>
                      </span>
                    </li>
                  </ul>
                </div>
                <div class="col-md-6">
                  <h6>Credentials</h6>
                  <ul class="list-unstyled">
                    <li>
                      <strong>SMTP_USER:</strong> 
                      <span class="badge bg-<%= process.env.SMTP_USER ? 'success' : 'danger' %>">
                        <%= process.env.SMTP_USER ? 'Set' : 'Not Set' %>
                      </span>
                      <% if (process.env.SMTP_USER) { %>
                        <small class="text-muted">(<%= process.env.SMTP_USER.substring(0, 3) %>***)</small>
                      <% } %>
                    </li>
                    <li>
                      <strong>SMTP_PASS:</strong> 
                      <span class="badge bg-<%= process.env.SMTP_PASS ? 'success' : 'danger' %>">
                        <%= process.env.SMTP_PASS ? 'Set' : 'Not Set' %>
                      </span>
                      <% if (process.env.SMTP_PASS) { %>
                        <small class="text-muted">(***)</small>
                      <% } %>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <!-- Test Email Section -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="fas fa-paper-plane me-2"></i>Test Email Service</h5>
            </div>
            <div class="card-body">
              <% if (status.initialized) { %>
                <p class="text-muted">Send a test email to verify the email service is working correctly.</p>
                <form action="/admin/test-email" method="POST" class="row g-3">
                  <div class="col-md-8">
                    <label for="testEmail" class="form-label">Test Email Address</label>
                    <input type="email" class="form-control" id="testEmail" name="testEmail" 
                           placeholder="Enter email address to test" required
                           value="<%= process.env.SMTP_USER || 'admin@benix.space' %>">
                  </div>
                  <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                      <i class="fas fa-paper-plane me-1"></i>Send Test Email
                    </button>
                  </div>
                </form>
                
                <% if (status.fallback_mode) { %>
                  <div class="alert alert-warning mt-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Fallback Mode:</strong> Test emails will be logged to the console instead of being sent.
                  </div>
                <% } %>
              <% } else { %>
                <div class="alert alert-danger">
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  Email service is not initialized. Please check your SMTP configuration.
                </div>
              <% } %>
            </div>
          </div>

          <!-- Configuration Help -->
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0"><i class="fas fa-question-circle me-2"></i>Configuration Help</h5>
            </div>
            <div class="card-body">
              <h6>To configure email service, set these environment variables in your .env file:</h6>
              <div class="config-detail">
# SMTP Configuration<br>
SMTP_HOST=your-smtp-server.com<br>
SMTP_PORT=587<br>
SMTP_SECURE=false<br>
SMTP_USER=your-email@domain.com<br>
SMTP_PASS=your-email-password<br>
              </div>
              
              <h6 class="mt-3">Common SMTP Providers:</h6>
              <div class="row">
                <div class="col-md-4">
                  <strong>Gmail:</strong><br>
                  <small>
                    Host: smtp.gmail.com<br>
                    Port: 587<br>
                    Secure: false
                  </small>
                </div>
                <div class="col-md-4">
                  <strong>Outlook:</strong><br>
                  <small>
                    Host: smtp-mail.outlook.com<br>
                    Port: 587<br>
                    Secure: false
                  </small>
                </div>
                <div class="col-md-4">
                  <strong>Custom Domain:</strong><br>
                  <small>
                    Host: mail.yourdomain.com<br>
                    Port: 465 (SSL) or 587 (TLS)<br>
                    Secure: true (465) or false (587)
                  </small>
                </div>
              </div>
              
              <div class="alert alert-info mt-3">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Note:</strong> For Gmail, you need to use an "App Password" instead of your regular password when 2FA is enabled.
              </div>
            </div>
          </div>
        </div>
      </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
