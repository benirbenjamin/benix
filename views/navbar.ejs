<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
  <div class="container">
    <a class="navbar-brand" href="/"><img src="/static/img/logo.png" alt="Benix Space Logo" width="100px" height="90px"></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item">
          <a class="nav-link" href="/">Home</a>
        </li>
        <% if (typeof user !== 'undefined' && user) { %>
          <li class="nav-item">
            <a class="nav-link" href="/dashboard">Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/user/products">Shop</a>
          </li>
          <% if (user.role === 'merchant' || user.role === 'admin') { %>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="merchantDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Merchant
              </a>
              <ul class="dropdown-menu" aria-labelledby="merchantDropdown">
                <li><a class="dropdown-item" href="/merchant/links">My Links</a></li>
                <li><a class="dropdown-item" href="/merchant/links/create">Create Link</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="/merchant-user/products">My Products</a></li>
                <li><a class="dropdown-item" href="/merchant-user/products/create">Add Product</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="/merchant/orders">Manage Orders</a></li>
              </ul>
            </li>
          <% } %>
          <% if (user.role === 'admin') { %>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Admin
              </a>
              <ul class="dropdown-menu" aria-labelledby="adminDropdown">
                <li><a class="dropdown-item" href="/admin/dashboard"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="/admin/products"><i class="fas fa-box me-2"></i>Manage Products</a></li>
                <li><a class="dropdown-item" href="/admin/links"><i class="fas fa-link me-2"></i>Manage Links</a></li>
                <li><a class="dropdown-item" href="/admin/users"><i class="fas fa-users me-2"></i>Manage Users</a></li>
                <li><a class="dropdown-item" href="/admin/orders"><i class="fas fa-shopping-bag me-2"></i>Manage Orders</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="/admin/merchants"><i class="fas fa-store me-2"></i>Manage Merchants</a></li>
                <li><a class="dropdown-item" href="/admin/transactions"><i class="fas fa-money-bill me-2"></i>Transactions</a></li>
                <li><a class="dropdown-item" href="/admin/commissions"><i class="fas fa-percentage me-2"></i>Commissions</a></li>
                <li><a class="dropdown-item" href="/admin/blog-posts"><i class="fas fa-pencil-alt me-2"></i>Blog Posts</a></li>
                <li><a class="dropdown-item" href="/admin/activation-payments"><i class="fas fa-credit-card me-2"></i>Activation Payments</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="/admin/settings"><i class="fas fa-cog me-2"></i>System Settings</a></li>
              </ul>
            </li>
          <% } %>
          <% if (user.role === 'user') { %>
            <li class="nav-item">
              <a class="nav-link" href="/upgrade-commission">Upgrade</a>
            </li>
          <% } %>
        <% } %>
      </ul>

        <ul class="navbar-nav ms-auto">
        <!-- Currency Switcher -->
        <li class="nav-item d-flex align-items-center me-3">
          <%- include('currency-switcher') %>
        </li>
    
        <!-- Install App Button (Hidden by default, shown by JS when installable) -->
        <li class="nav-item">
          <button id="install-app" class="btn btn-success btn-sm my-1 mx-2" style="display: none;">
            <i class="fas fa-download me-1"></i> Install App
          </button>
        </li>
        <% if (typeof user !== 'undefined' && user) { %>
          <li class="nav-item">
            <a class="nav-link position-relative" href="/cart">
              <i class="fas fa-shopping-cart"></i>
              <% if (typeof cartCount !== 'undefined' && cartCount > 0) { %>
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                  <%= cartCount %>
                  <span class="visually-hidden">items in cart</span>
                </span>
              <% } %>
            </a>
          </li>
          <!-- User dropdown menu for logged in users -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <%= user.username %>
            </a>            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
              <li><a class="dropdown-item" href="/dashboard">Dashboard</a></li>
              <li><a class="dropdown-item" href="/profile">My Profile</a></li>
              <li><a class="dropdown-item" href="/orders"><i class="bi bi-box me-2"></i>My Orders</a></li>
              <li><a class="dropdown-item" href="/wallet">My Wallet</a></li>
              <li> <a class="dropdwon-item" href="/referrals">My Referrals</a></li>
              <% if (user.role === 'merchant') { %>
                <li><a class="dropdown-item" href="/merchant/links">My Links</a></li>
                <li><a class="dropdown-item" href="/merchant-user/products">My Products</a></li>
              <% } %>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="/logout">Logout</a></li>
            </ul>
          </li>
        <% } else { %>
          <li class="nav-item">
            <a class="nav-link" href="/login"><i class="fas fa-sign-in-alt me-1"></i> Login</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/register"><i class="fas fa-user-plus me-1"></i> Register</a>
          </li>
        <% } %>
      </ul>
    </div>
  </div>
</nav>

<style>
/* Fix navbar positioning and ensure it stays on top */
.navbar {
  position: relative;
  z-index: 1030;
  overflow: visible;
}

.navbar-collapse {
  overflow: visible;
}

/* Fix dropdown menu positioning and remove scroll issues */
.navbar-nav .dropdown-menu {
  position: absolute;
  z-index: 1050;
  top: 100%;
  left: 0;
  min-width: 200px;
  max-height: none;
  overflow: visible;
  border: 1px solid rgba(0,0,0,.15);
  border-radius: 0.375rem;
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
  background-color: #fff;
  margin-top: 0;
}

/* Ensure dropdown menus appear above other content */
.dropdown-menu.show {
  display: block;
  position: absolute;
  z-index: 1050;
}

/* Right-aligned dropdown menus */
.dropdown-menu-end {
  right: 0;
  left: auto;
}

/* Remove any constraints that could cause scrolling */
.dropdown {
  position: relative;
}

/* Mobile responsive adjustments */
@media (max-width: 991.98px) {
  .navbar-nav .dropdown-menu {
    position: static;
    float: none;
    width: 100%;
    margin-top: 0;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0;
    box-shadow: none;
    max-height: none;
    overflow: visible;
  }
  
  .dropdown-menu.show {
    position: static;
  }
  
  /* Disable hover effects on mobile */
  .dropdown:hover .dropdown-menu {
    display: none !important;
  }
}

/* Desktop hover effects */
@media (min-width: 992px) {
  .dropdown:hover .dropdown-menu {
    display: block;
    opacity: 1;
    visibility: visible;
  }
  
  .dropdown-menu {
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
  }
  
  .dropdown-menu.show {
    opacity: 1;
    visibility: visible;
  }
}

/* Prevent any overflow issues on the page */
body {
  overflow-x: hidden;
}

/* Ensure proper stacking context */
.container {
  position: relative;
}
</style>

<script>
// Ensure dropdowns work properly on all devices
document.addEventListener('DOMContentLoaded', function() {
  // Initialize Bootstrap dropdowns
  var dropdownElementList = [].slice.call(document.querySelectorAll('.dropdown-toggle'));
  var dropdownList = dropdownElementList.map(function (dropdownToggleEl) {
    return new bootstrap.Dropdown(dropdownToggleEl);
  });

  // For desktop hover effects
  if (window.innerWidth >= 992) {
    var dropdowns = document.querySelectorAll('.dropdown');
    
    dropdowns.forEach(function(dropdown) {
      dropdown.addEventListener('mouseenter', function() {
        var dropdownMenu = this.querySelector('.dropdown-menu');
        var dropdownToggle = this.querySelector('.dropdown-toggle');
        
        if (dropdownMenu && dropdownToggle) {
          dropdownMenu.classList.add('show');
          dropdownToggle.setAttribute('aria-expanded', 'true');
        }
      });
      
      dropdown.addEventListener('mouseleave', function() {
        var dropdownMenu = this.querySelector('.dropdown-menu');
        var dropdownToggle = this.querySelector('.dropdown-toggle');
        
        if (dropdownMenu && dropdownToggle) {
          dropdownMenu.classList.remove('show');
          dropdownToggle.setAttribute('aria-expanded', 'false');
        }
      });
    });
  }

  // Prevent default link behavior for dropdown toggles
  var dropdownToggleList = document.querySelectorAll('.dropdown-toggle');
  dropdownToggleList.forEach(function(toggle) {
    toggle.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
    });
  });

  // Close dropdowns when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.dropdown')) {
      var openDropdowns = document.querySelectorAll('.dropdown-menu.show');
      openDropdowns.forEach(function(menu) {
        menu.classList.remove('show');
        var toggle = menu.parentNode.querySelector('.dropdown-toggle');
        if (toggle) {
          toggle.setAttribute('aria-expanded', 'false');
        }
      });
    }
  });

  // Handle window resize to reset hover effects
  window.addEventListener('resize', function() {
    if (window.innerWidth < 992) {
      // Remove all hover-triggered show states on mobile
      var openDropdowns = document.querySelectorAll('.dropdown-menu.show');
      openDropdowns.forEach(function(menu) {
        if (!menu.closest('.dropdown').querySelector('.dropdown-toggle[aria-expanded="true"]')) {
          menu.classList.remove('show');
        }
      });
    }
  });

  <% if (typeof user !== 'undefined' && user) { -%>
  // Session timeout warning
  let sessionWarningShown = false;
  const SESSION_TIMEOUT = <%= (parseInt(process.env.SESSION_TIMEOUT_HOURS) || 1) * 60 * 60 * 1000 %>; // Session timeout in milliseconds from server
  const WARNING_TIME = 5 * 60 * 1000; // Show warning 5 minutes before expiry
  
  let sessionTimer;
  
  function checkSessionTimeout() {
    // Clear any existing timer
    if (sessionTimer) {
      clearTimeout(sessionTimer);
    }
    
    // Show warning 5 minutes before session expires
    sessionTimer = setTimeout(() => {
      if (!sessionWarningShown) {
        sessionWarningShown = true;
        if (confirm('Your session will expire in 5 minutes due to inactivity. Click OK to stay logged in or Cancel to logout now.')) {
          // User wants to stay logged in - make a request to extend session
          fetch('/api/extend-session', { 
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                sessionWarningShown = false;
                checkSessionTimeout(); // Reset the timer
              } else {
                alert('Unable to extend session. You will be logged out.');
                window.location.href = '/logout';
              }
            })
            .catch(() => {
              alert('Unable to extend session. You will be logged out.');
              window.location.href = '/logout';
            });
        } else {
          // User chose to logout
          window.location.href = '/logout';
        }
      }
    }, SESSION_TIMEOUT - WARNING_TIME);
  }
  
  // Start session monitoring
  checkSessionTimeout();
  
  // Reset session timer on user activity
  let activityTimer;
  function resetActivityTimer() {
    if (sessionWarningShown) {
      sessionWarningShown = false;
    }
    clearTimeout(activityTimer);
    activityTimer = setTimeout(() => {
      checkSessionTimeout();
    }, 1000); // Debounce activity detection
  }
  
  ['click', 'keypress', 'scroll', 'mousemove'].forEach(event => {
    document.addEventListener(event, resetActivityTimer, { passive: true });
  });
  <% } -%>
});
</script>