<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - BenixSpace</title>
    <link rel="icon" href="/static/img/favicon.png" type="image/png" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS for Login Bonus Modal -->
    <style>
        .bonus-modal-content {
            animation: bonusSlideIn 0.5s ease-out;
        }
        
        @keyframes bonusSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .bonus-amount {
            animation: bounceIn 0.8s ease-out 0.3s both;
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.1); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .bonus-icon {
            animation: rotate 2s ease-in-out infinite;
        }
        
        @keyframes rotate {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(10deg); }
        }
        
        .modal-backdrop-custom {
            background: linear-gradient(45deg, rgba(40, 167, 69, 0.1), rgba(32, 201, 151, 0.1));
        }
    </style>
    
    <!-- AdSense and Analytics -->
    <%- include('partials/adsense') %>
</head>
<body class="bg-light">
    <%- include('partials/navbar') %>

    <div class="container mt-4">
        <h1 class="mb-4">Dashboard</h1>
        
        <!-- Login Bonus Message - Enhanced Design -->
        <% if (loginBonusMessage) { %>
            <!-- Backdrop for modal effect -->
            <div class="modal fade show modal-backdrop-custom" id="loginBonusModal" tabindex="-1" style="display: block; background-color: rgba(0,0,0,0.5);" aria-labelledby="loginBonusModalLabel">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg bonus-modal-content">
                        <div class="modal-header bg-gradient" style="background: linear-gradient(45deg, #28a745, #20c997); color: white; border-bottom: none;">
                            <h5 class="modal-title" id="loginBonusModalLabel">
                                <i class="fas fa-gift me-2 bonus-icon"></i>Login Bonus Received!
                            </h5>
                        </div>
                        <div class="modal-body text-center py-4">
                            <div class="mb-3">
                                <i class="fas fa-coins fa-3x text-warning mb-3 bonus-icon"></i>
                            </div>
                            <h4 class="text-success mb-3">🎉 Congratulations! 🎉</h4>
                            <div class="mb-4 bonus-amount">
                                <h2 class="text-success mb-2">
                                    <i class="fas fa-dollar-sign"></i><%= dailyLoginBonus.toFixed(2) %>
                                </h2>
                                <p class="text-muted">Daily Login Bonus Received!</p>
                            </div>
                            <p class="mb-3" style="font-size: 1.1em;">
                                <%= loginBonusMessage %>
                            </p>
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Your wallet and earnings have been updated!
                            </div>
                        </div>
                        <div class="modal-footer border-0 justify-content-center">
                            <button type="button" class="btn btn-success btn-lg px-4" onclick="closeBonusModal()">
                                <i class="fas fa-check me-2"></i>Awesome, Thanks!
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Alternative: Enhanced Alert (if you prefer alert style) -->
            <div class="alert alert-success alert-dismissible fade show border-0 shadow-sm d-none" role="alert" id="bonusAlert" style="background: linear-gradient(45deg, #d4edda, #c3e6cb);">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <i class="fas fa-gift fa-2x text-success"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h5 class="alert-heading mb-1">
                            <i class="fas fa-coins me-2"></i>Login Bonus Received!
                        </h5>
                        <p class="mb-2"><%= loginBonusMessage %></p>
                        <small class="text-muted">
                            <i class="fas fa-wallet me-1"></i>Your wallet and earnings have been updated!
                        </small>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
        <% } %>
        
        <% if (user.role === 'admin') { %>
            <!-- Admin Dashboard -->
            <div class="row dashboard-stats">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-users stat-icon mb-3"></i>
                            <h5 class="card-title">Total Users</h5>
                            <h2><%= stats.userCount %></h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-store stat-icon mb-3"></i>
                            <h5 class="card-title">Merchants</h5>
                            <h2><%= stats.merchantCount %></h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-link stat-icon mb-3"></i>
                            <h5 class="card-title">Links</h5>
                            <h2><%= stats.linkCount %></h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-mouse-pointer stat-icon mb-3"></i>
                            <h5 class="card-title">Total Clicks</h5>
                            <h2><%= stats.clickCount %></h2>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header">Recent Transactions</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <% if (stats.recentTransactions && stats.recentTransactions.length > 0) { %>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Type</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% stats.recentTransactions.forEach(transaction => { %>
                                    <tr>
                                        <td><%= transaction.username %></td>
                                        <td><span class="badge bg-<%= 
                                            transaction.type === 'deposit' ? 'success' : 
                                            transaction.type === 'withdrawal' ? 'warning' : 
                                            transaction.type === 'commission' ? 'info' : 
                                            'secondary' %>"><%= transaction.type %></span></td>
                                        <td>$<%= parseFloat(transaction.amount).toFixed(4) %></td>
                                        <td><span class="badge bg-<%= 
                                            transaction.status === 'completed' ? 'success' : 
                                            transaction.status === 'pending' ? 'warning' : 
                                            'danger' %>"><%= transaction.status %></span></td>
                                        <td><%= new Date(transaction.created_at).toLocaleString() %></td>
                                    </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        <% } else { %>
                            <div class="alert alert-info">No recent transactions found.</div>
                        <% } %>
                    </div>
                </div>
            </div>
        <% } else if (user.role === 'merchant') { %>
            <!-- Merchant Dashboard -->
            <div class="row dashboard-stats">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-money-bill-wave stat-icon mb-3 text-warning"></i>
                            <h5 class="card-title">Amount to Pay</h5>
                            <h2>$<%= parseFloat(stats.amountToPay).toFixed(4) %></h2>
                            <small class="text-muted">Amount due for clicks</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-check-circle stat-icon mb-3 text-success"></i>
                            <h5 class="card-title">Total Paid</h5>
                            <h2>$<%= parseFloat(stats.paidBalance).toFixed(4) %></h2>
                            <small class="text-muted">All-time payments</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-link stat-icon mb-3 text-primary"></i>
                            <h5 class="card-title">Active Links</h5>
                            <h2><%= stats.linkCount %></h2>
                        </div>
                        <div class="card-footer">
                            <a href="/merchant/links" class="btn btn-sm btn-primary">View All</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-mouse-pointer stat-icon mb-3 text-info"></i>
                            <h5 class="card-title">Total Clicks</h5>
                            <h2><%= stats.totalClicks %></h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Instructions -->
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Billing Information</h5>
                            <a href="https://wa.me/250783987223?text=hello%20admin%20of%20benixspace" class="btn btn-sm btn-outline-secondary" target="_blank">
                                <i class="fas fa-question-circle me-1"></i> Submit inquiry on whatsapp
                            </a>
                        </div>
                        <div class="card-body">
                            <div class="alert <%= parseFloat(stats.amountToPay) > 0 ? 'alert-warning' : 'alert-success' %>">
                                <i class="fas <%= parseFloat(stats.amountToPay) > 0 ? 'fa-exclamation-triangle' : 'fa-check-circle' %> me-2"></i>
                                <strong>Payment Status:</strong> 
                                <% if (parseFloat(stats.amountToPay) > 0) { %>
                                    You currently have an outstanding balance of <strong>$<%= parseFloat(stats.amountToPay).toFixed(4) %></strong>.
                                    Please make a payment to continue using all features.
                                <% } else { %>
                                    Your account is in good standing. No payment is currently due.
                                <% } %>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-info-circle me-2"></i> About the Billing Model</h6>
                                    <p>Our post-pay billing model allows you to pay for clicks after they occur. You're charged per click based on your link settings, and you'll only pay for actual traffic received.</p>
                                    <p>We calculate your balance at the end of each month or when it reaches a significant amount. Contact support for payment options.</p>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-credit-card me-2"></i> How to Pay</h6>
                                    <ol>
                                        <li>Make a payment to one of our payment methods: 1. MOMO: 0783987223, Code: 672747, Bank: 4010100405471 (names: Benjamin IRABISHOHOJE)  </li>
                                        <li>Email your receipt to <a href="mailto:benirabok@gmail.com">benirabok@gmail.com</a></li>
                                        <li>Or contact admin via whatsapp <a href="https://wa.me/250783987223?text=Hello%20Admin%20of%20BenixSpace.%20I%20have%20paid%20please%20update%20my%20balance.%20Thank%20you.">(Contact admin on whatsapp)</a></li>
                                        <li>Include your merchant username and payment amount</li>
                                        <li>Admin will update your balance within 24 hours</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Merchant Analytics Section -->
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Your Analytics Overview</h5>
                          
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-2">
                                    <div class="text-center">
                                        <h4 class="text-primary"><%= stats.linkCount %></h4>
                                        <small class="text-muted">Active Links</small>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="text-center">
                                        <h4 class="text-info"><%= stats.totalClicks %></h4>
                                        <small class="text-muted">Total Clicks</small>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="text-center">
                                        <h4 class="text-success">$<%= parseFloat(stats.amountToPay || 0).toFixed(2) %></h4>
                                        <small class="text-muted">Amount Due</small>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="text-center">
                                        <h4 class="text-warning">$<%= parseFloat(stats.paidBalance || 0).toFixed(2) %></h4>
                                        <small class="text-muted">Paid Balance</small>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="text-center">
                                        <h4 class="text-danger">$<%= (parseFloat(stats.amountToPay || 0) + parseFloat(stats.paidBalance || 0)).toFixed(2) %></h4>
                                        <small class="text-muted">Total Revenue</small>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="text-center">
                                        <% const avgCPC = stats.linkCount > 0 ? (parseFloat(stats.amountToPay || 0) + parseFloat(stats.paidBalance || 0)) / stats.totalClicks : 0 %>
                                        <h4 class="text-secondary">$<%= avgCPC.toFixed(4) %></h4>
                                        <small class="text-muted">Avg CPC</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Performance Indicators -->
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-muted">Click Performance:</span>
                                        <div class="progress" style="width: 200px; height: 8px;">
                                            <% 
                                                // Calculate performance percentage (assuming 1000 clicks is 100%)
                                                const performancePercent = Math.min((stats.totalClicks / 1000) * 100, 100);
                                            %>
                                            <div class="progress-bar bg-<%= performancePercent > 75 ? 'success' : performancePercent > 50 ? 'warning' : 'danger' %>" 
                                                 style="width: <%= performancePercent %>%"></div>
                                        </div>
                                        <span class="text-muted"><%= performancePercent.toFixed(1) %>%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Link Performance Overview -->
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Link Performance</h5>
                        </div>
                        <div class="card-body">
                            <% if (stats.links && stats.links.length > 0) { %>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Link Title</th>
                                                <th>Type</th>
                                                <th>Clicks</th>
                                                <th>Cost/Click</th>
                                                <th>Total Cost</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% stats.links.forEach(link => { %>
                                                <tr>
                                                    <td><%= link.title %></td>
                                                    <td><span class="badge bg-<%= 
                                                        link.type === 'product' ? 'success' : 
                                                        link.type === 'youtube' ? 'danger' : 
                                                        'primary' %>"><%= link.type %></span></td>
                                                    <td><%= link.clicks_count %></td>
                                                    <td>$<%= parseFloat(link.cost_per_click).toFixed(3) %></td>
                                                    <td>$<%= (parseFloat(link.cost_per_click) * link.clicks_count).toFixed(4) %></td>
                                                    <td><span class="badge bg-<%= link.is_active ? 'success' : 'secondary' %>">
                                                        <%= link.is_active ? 'Active' : 'Inactive' %>
                                                    </span></td>
                                                    <td>
                                                        <a href="/merchant/links/<%= link.id %>" class="btn btn-sm btn-outline-info">
                                                            <i class="fas fa-chart-line"></i>
                                                        </a>
                                                    </td>
                                                </tr>
                                            <% }); %>
                                        </tbody>
                                    </table>
                                </div>
                            <% } else { %>
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    You haven't created any links yet. <a href="/merchant/links/new">Create your first link</a> to start promoting.
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        <% } else { %>
            <!-- Regular User Dashboard -->
            <div class="row dashboard-stats">
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-money-bill-wave stat-icon mb-3"></i>
                            <h5 class="card-title">My Earnings</h5>
                            <h2>$<%= parseFloat(user.earnings).toFixed(4) %></h2>
                        </div>
                        <div class="card-footer">
                            <a href="/wallet" class="btn btn-sm btn-primary">View Wallet</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-share-alt stat-icon mb-3"></i>
                            <h5 class="card-title">Shared Links</h5>
                            <h2><%= stats.sharedLinkCount %></h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-mouse-pointer stat-icon mb-3"></i>
                            <h5 class="card-title">Total Clicks</h5>
                            <h2><%= stats.totalClicks %></h2>
                        </div>
                        <div class="card-footer">
                            <% if (!user.has_lifetime_commission) { %>
                                <a href="/upgrade-commission" class="btn btn-sm btn-warning">Upgrade Commission</a>
                            <% } else { %>
                                <span class="badge bg-success">Premium Member</span>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Recent Activity</h5>
                </div>
                <div class="card-body">
                    <% if (stats.sharedLinks && stats.sharedLinks.length > 0) { %>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Link</th>
                                        <th>Clicks</th>
                                        <th>Earnings</th>
                                        <th>Share URL</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% stats.sharedLinks.forEach(link => { %>
                                    <tr>
                                        <td><%= link.title %></td>
                                        <td><%= link.clicks %></td>
                                        <td>$<%= parseFloat(link.earnings).toFixed(4) %></td>
                                        <td>
                                            <div class="input-group">
                                                <input type="text" class="form-control form-control-sm" 
                                                    value="/s/<%= link.share_code %>" readonly>
                                                <button class="btn btn-sm btn-outline-primary copy-btn" 
                                                    data-clipboard-text="/s/<%= link.share_code %>">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary share-btn" 
                                                data-share-url="/s/<%= link.share_code %>"
                                                data-share-title="<%= link.title %>">
                                                <i class="fas fa-share-alt"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    <% } else { %>
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            You haven't shared any links yet. Start sharing to earn!
                        </div>
                    <% } %>
                </div>
            </div>
        <% } %>
        
        <!-- Leaderboard Section (visible to all users) -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">🏆 Top Performers Leaderboard</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>User</th>
                                <th>Referrals</th>
                                <th>Links Shared</th>
                                <th>Orders</th>
                                <th>Wallet</th>
                                <th>Earnings</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (topPerformers && topPerformers.length > 0) { %>
                                <% topPerformers.forEach((performer, index) => { %>
                                    <tr class="<%= performer.id === user.id ? 'table-primary' : '' %>">
                                        <td>
                                            <% if (index === 0) { %>
                                                <span class="badge bg-warning text-dark">🥇 #1</span>
                                            <% } else if (index === 1) { %>
                                                <span class="badge bg-secondary">🥈 #2</span>
                                            <% } else if (index === 2) { %>
                                                <span class="badge bg-dark">🥉 #3</span>
                                            <% } else { %>
                                                <span class="badge bg-light text-dark">#<%= index + 1 %></span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <%= performer.username %>
                                            <% if (performer.id === user.id) { %>
                                                <small class="text-primary">(You)</small>
                                            <% } %>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">
                                                <%= performer.referral_count %>
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-success">
                                                <%= performer.total_shared_links %>
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-primary">
                                                <%= performer.total_orders %>
                                            </span>
                                        </td>
                                        <td>$<%= parseFloat(performer.wallet || 0).toFixed(4) %></td>
                                        <td>$<%= parseFloat(performer.earnings || 0).toFixed(4) %></td>
                                        <td>
                                            <span class="badge bg-dark">
                                                <%= Math.round(performer.performance_score) %>
                                            </span>
                                        </td>
                                    </tr>
                                <% }) %>
                            <% } else { %>
                                <tr>
                                    <td colspan="8" class="text-center py-3">No performance data available</td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer text-muted">
                <small>
                    <i class="fas fa-info-circle"></i>
                    Performance score is calculated based on wallet balance, earnings, referrals, and links shared.
                </small>
            </div>
        </div>
    </div>

    <%- include('partials/footer') %>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>
    <script>
        // Initialize clipboard.js
        new ClipboardJS('.copy-btn');

        // Handle copy button feedback
        document.querySelectorAll('.copy-btn').forEach(button => {
            button.addEventListener('click', () => {
                const originalContent = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    button.innerHTML = originalContent;
                }, 2000);
            });
        });

        // Handle share buttons
        document.querySelectorAll('.share-btn').forEach(button => {
            button.addEventListener('click', () => {
                const url = button.dataset.shareUrl;
                const title = button.dataset.shareTitle;
                if (navigator.share) {
                    navigator.share({
                        title: title,
                        url: url
                    });
                } else {
                    // Fallback for browsers that don't support Web Share API
                    const dummy = document.createElement('input');
                    document.body.appendChild(dummy);
                    dummy.value = url;
                    dummy.select();
                    document.execCommand('copy');
                    document.body.removeChild(dummy);
                    alert('Link copied to clipboard!');
                }
            });
        });
        
        // Login Bonus Modal Functions
        function closeBonusModal() {
            const modal = document.getElementById('loginBonusModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.classList.remove('modal-open');
                // Remove backdrop
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.remove();
                }
            }
        }
    </script>
    
    <!-- Login Bonus Modal Auto-close Script -->
    <% if (loginBonusMessage) { %>
    <script>
        // Auto-close modal after 10 seconds
        setTimeout(function() {
            closeBonusModal();
        }, 10000);
        
        // Add body class for modal
        document.body.classList.add('modal-open');
        
        // Allow ESC key to close modal
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeBonusModal();
            }
        });
    </script>
    <% } %>
</body>
</html>